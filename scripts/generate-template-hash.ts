import { createHash } from "node:crypto";
import { readFileSync, writeFileSync } from "node:fs";
import { resolve } from "node:path";
import { fileURLToPath } from "node:url";

export const ROOT_DIR = resolve(import.meta.dirname, "..");

/**
 * Generate a template hash for ETag versioning.
 * The hash changes when the following file is modified:
 * - shared/templates/view.template.tsx
 */
export function generateTemplateHash(): string {
	const templatePath = resolve(ROOT_DIR, "shared/templates/view.template.tsx");
	const templateContent = readFileSync(templatePath, "utf-8");
	const hash = createHash("md5");
	hash.update(templateContent);
	return hash.digest("hex").slice(0, 5);
}

function main() {
	const templateHash = generateTemplateHash();

	const outputPath = resolve(
		ROOT_DIR,
		"shared/templates/template-hash.generated.ts",
	);
	const content = `// This file is auto-generated by scripts/generate-template-hash.ts
// Do not edit manually. Run "pnpm generate:hash" to regenerate.
export const TEMPLATE_HASH = "${templateHash}";

export function getTemplateHash(): string {
	return TEMPLATE_HASH;
}
`;

	writeFileSync(outputPath, content);
	console.log("âœ“ Generated template hash:", templateHash);
}

const isDirectExecution = (() => {
	const entryFromArgv = process.argv[1];
	if (!entryFromArgv) return false;
	return fileURLToPath(import.meta.url) === entryFromArgv;
})();

if (isDirectExecution) {
	main();
}
